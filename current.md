# omobaf å‰ç«¯é–‹ç™¼ç‹€æ…‹ - 2025/08/06

## å°ˆæ¡ˆæ¦‚è¿°
omobaf (Open MOBA Frontend) - å‡éŠæˆ²å‰ç«¯å®¢æˆ¶ç«¯ï¼Œç”¨æ–¼æ¸¬è©¦ omobab å¾Œç«¯çš„éŠæˆ²é‚è¼¯ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. å‰ç«¯è‡ªå‹•é€£æ¥æœ¬åœ°ç«¯ (å·²å®Œæˆ)
- **å•é¡Œ**: å‰ç«¯åŸ·è¡Œæ™‚æ²’æœ‰é è¨­ç›´é€£æœ¬åœ°ç«¯
- **è§£æ±ºæ–¹æ¡ˆ**: åœ¨ `InteractiveCli::run()` ä¸­æ·»åŠ  `auto_connect_localhost()` æ–¹æ³•
- **æ–‡ä»¶**: `src/interactive.rs:41-49`
- **ç‹€æ…‹**: âœ… å‰ç«¯å•Ÿå‹•æ™‚è‡ªå‹•é€£æ¥åˆ° 127.0.0.1:1883

### 2. å‰ç«¯ä¸»å‹•è«‹æ±‚ç•¶å‰éŠæˆ²ç•«é¢ç‹€æ…‹ (å·²å®Œæˆ)
- **å•é¡Œ**: å‰ç«¯æ²’æœ‰ä¸»å‹•å‘å¾Œç«¯è«‹æ±‚éŠæˆ²ç•«é¢ç‹€æ…‹
- **è§£æ±ºæ–¹æ¡ˆ**: å¯¦ä½œç•«é¢ç‹€æ…‹è«‹æ±‚å¾ªç’°ï¼Œæ¯3ç§’ç™¼é€ä¸€æ¬¡MQTTè«‹æ±‚
- **æ–‡ä»¶**: `src/game_client.rs:300-350`
- **å”è­°**: 
  - è«‹æ±‚ä¸»é¡Œ: `td/{player_name}/request`
  - å›æ‡‰ä¸»é¡Œ: `td/{player_name}/screen_response`

### 3. å¢å¼·ç•«é¢è«‹æ±‚å”è­° (å·²å®Œæˆ)
- **åŠŸèƒ½**: æ”¯æ´å…©ç¨®è«‹æ±‚æ¨¡å¼
  - **player_centered**: ä»¥ç©å®¶ç‚ºä¸­å¿ƒ Â±60x, Â±40y ç¯„åœ
  - **fixed_area**: å›ºå®šç¯„åœ (å¦‚ -40,-40 åˆ° 40,40)
- **æ•¸æ“šçµæ§‹**: å®Œæ•´çš„ç•«é¢æ•¸æ“š(å¯¦é«”ã€ç©å®¶ã€æŠ•å°„ç‰©ã€åœ°å½¢)
- **æ–‡ä»¶**: `src/mqtt_handler.rs:376-429`

### 4. MQTTè™•ç†å™¨å¢å¼· (å·²å®Œæˆ)
- **æ–°å¢**: `handle_screen_response_message()` æ–¹æ³•
- **åŠŸèƒ½**: è™•ç† `td/+/screen_response` ä¸»é¡Œ
- **æ•´åˆ**: å°‡ç¶²è·¯å¯¦é«”è½‰æ›ç‚ºæœ¬åœ°å¯¦é«”æ ¼å¼
- **æ–‡ä»¶**: `src/mqtt_handler.rs:242-305`

### 5. å‰ç«¯è‡ªå‹•å•Ÿå‹•å¾Œç«¯åŠŸèƒ½ (å·²å®Œæˆ) ğŸ‰
- **æ ¸å¿ƒåŠŸèƒ½**: å‰ç«¯æ ¹æ“šé…ç½®è‡ªå‹•å•Ÿå‹•å’Œç®¡ç†å¾Œç«¯ç¨‹åº
- **é…ç½®ç³»çµ±**: `config.toml` é…ç½®å¾Œç«¯åŸ·è¡Œè·¯å¾‘å’Œåƒæ•¸
- **å¾Œç«¯ç®¡ç†**: æ”¯æ´ start/stop/restart/status å‘½ä»¤
- **å·¥ä½œç›®éŒ„**: æ­£ç¢ºè¨­å®šå¾Œç«¯å·¥ä½œç›®éŒ„ä»¥è®€å– log4rs.yml

#### å¯¦ä½œæª”æ¡ˆ:
- `src/config.rs` - é…ç½®æª”æ¡ˆè™•ç†
- `src/backend_manager.rs` - å¾Œç«¯ç¨‹åºç”Ÿå‘½é€±æœŸç®¡ç†
- `src/interactive.rs` - æ•´åˆå¾Œç«¯ç®¡ç†åˆ°äº¤äº’ç•Œé¢
- `config.toml` - é…ç½®æª”æ¡ˆ

#### å¾Œç«¯ç®¡ç†å‘½ä»¤:
```bash
backend start    # å•Ÿå‹•å¾Œç«¯
backend stop     # åœæ­¢å¾Œç«¯
backend restart  # é‡å•Ÿå¾Œç«¯
backend status   # æŸ¥çœ‹ç‹€æ…‹
```

### 6. å‘½ä»¤åˆ—ç›´æ¥é€²å…¥è¦–åœ–æ¨¡å¼ (å·²å®Œæˆ)
- **å‘½ä»¤**: `cargo run --bin omobaf -- interactive --auto-view`
- **åŠŸèƒ½**: ç›´æ¥é€²å…¥éŠæˆ²ä¸¦å•Ÿå‹•å¯¦æ™‚è¦–åœ–
- **åƒæ•¸**: `--size`, `--show-vision`
- **æ–‡ä»¶**: `src/cli.rs:27-34`

## ğŸ”§ é…ç½®æ–‡ä»¶

### config.toml
```toml
[server]
mqtt_host = "127.0.0.1"
mqtt_port = 1883

[backend]
executable_path = "../open_moba_backend/target/debug/omobab"
args = []
working_directory = "../open_moba_backend"

[backend.env]
RUST_LOG = "info"

[frontend]
player_name = "TestPlayer"
hero_type = "saika_magoichi"
auto_start_backend = true
backend_start_delay = 1000
backend_shutdown_timeout = 5000
```

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
omobaf/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs                  # ä¸»ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ cli.rs                   # å‘½ä»¤åˆ—åƒæ•¸è™•ç†
â”‚   â”œâ”€â”€ interactive.rs           # äº’å‹•å¼CLI (å«å¾Œç«¯ç®¡ç†)
â”‚   â”œâ”€â”€ game_client.rs           # éŠæˆ²å®¢æˆ¶ç«¯å’ŒMQTTé€šä¿¡
â”‚   â”œâ”€â”€ mqtt_handler.rs          # MQTTè¨Šæ¯è™•ç†å™¨
â”‚   â”œâ”€â”€ game_state.rs            # éŠæˆ²ç‹€æ…‹ç®¡ç†
â”‚   â”œâ”€â”€ player.rs                # ç©å®¶æ¨¡æ“¬å™¨
â”‚   â”œâ”€â”€ terminal_view.rs         # çµ‚ç«¯è¦–åœ–æ¸²æŸ“
â”‚   â”œâ”€â”€ config.rs                # é…ç½®æª”æ¡ˆè™•ç†
â”‚   â””â”€â”€ backend_manager.rs       # å¾Œç«¯ç¨‹åºç®¡ç†
â”œâ”€â”€ config.toml                  # é…ç½®æª”æ¡ˆ
â”œâ”€â”€ test_backend_auto_start.sh   # å¾Œç«¯è‡ªå‹•å•Ÿå‹•æ¸¬è©¦è…³æœ¬
â””â”€â”€ Cargo.toml                   # Rustå°ˆæ¡ˆé…ç½®
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åŸºæœ¬å•Ÿå‹• (æ¨è–¦)
```bash
# å•Ÿå‹•å‰ç«¯ï¼Œè‡ªå‹•å•Ÿå‹•å¾Œç«¯ä¸¦é€£æ¥
./target/debug/omobaf
```

### ç›´æ¥é€²å…¥è¦–åœ–æ¨¡å¼
```bash
# ç›´æ¥é€²å…¥éŠæˆ²å¯¦æ™‚è¦–åœ–
./target/debug/omobaf interactive --auto-view --size 20
```

### å¾Œç«¯ç®¡ç†
```bash
# åœ¨äº’å‹•æ¨¡å¼ä¸­
backend status   # æŸ¥çœ‹å¾Œç«¯ç‹€æ…‹
backend restart  # é‡å•Ÿå¾Œç«¯
backend stop     # åœæ­¢å¾Œç«¯
```

## ğŸ”„ å·¥ä½œæµç¨‹

1. **å•Ÿå‹•**: `./target/debug/omobaf`
2. **è‡ªå‹•å•Ÿå‹•å¾Œç«¯**: æ ¹æ“š `config.toml` è¨­å®š
3. **è‡ªå‹•é€£æ¥**: é€£æ¥åˆ°å¾Œç«¯ MQTT æœå‹™å™¨ (127.0.0.1:1883)
4. **äº’å‹•æ¨¡å¼**: æ”¯æ´éŠæˆ²å‘½ä»¤å’Œå¾Œç«¯ç®¡ç†
5. **é€€å‡ºæ¸…ç†**: è‡ªå‹•åœæ­¢ç®¡ç†çš„å¾Œç«¯ç¨‹åº

## ğŸŒ MQTT é€šä¿¡å”è­°

### ç•«é¢ç‹€æ…‹è«‹æ±‚
```json
{
  "t": "screen_request",
  "a": "get_screen_area",
  "d": {
    "player_name": "TestPlayer",
    "request_type": "player_centered",
    "center_x": 0.0,
    "center_y": 0.0,
    "width": 120.0,
    "height": 80.0,
    "timestamp": 1672531200000
  }
}
```

### ç•«é¢ç‹€æ…‹å›æ‡‰
```json
{
  "t": "screen_response",
  "d": {
    "area": {"min_x": -60, "min_y": -40, "max_x": 60, "max_y": 40},
    "entities": [...],
    "players": [...],
    "projectiles": [...],
    "terrain": [...],
    "timestamp": 1672531200001
  }
}
```

## âœ¨ ä¸»è¦ç‰¹æ€§

- **é›¶é…ç½®å•Ÿå‹•**: åªéœ€åŸ·è¡Œå‰ç«¯ï¼Œå¾Œç«¯è‡ªå‹•å•Ÿå‹•
- **å®Œæ•´çš„å¾Œç«¯ç®¡ç†**: å•Ÿå‹•ã€åœæ­¢ã€é‡å•Ÿã€ç‹€æ…‹æŸ¥è©¢
- **è‡ªå‹•é€£æ¥**: å‰ç«¯è‡ªå‹•é€£æ¥åˆ°å¾Œç«¯ MQTT æœå‹™å™¨
- **å¯¦æ™‚ç•«é¢æ›´æ–°**: æ¯3ç§’è‡ªå‹•è«‹æ±‚éŠæˆ²ç‹€æ…‹
- **éˆæ´»çš„è¦–åœ–æ¨¡å¼**: æ”¯æ´å›ºå®šç¯„åœå’Œç©å®¶ä¸­å¿ƒè¦–åœ–
- **çµ‚ç«¯è¦–åœ–**: æ”¯æ´æ»‘é¼ æ“ä½œçš„å¯¦æ™‚éŠæˆ²è¦–åœ–
- **å®Œæ•´çš„MQTTé€šä¿¡**: æ”¯æ´æ‰€æœ‰éŠæˆ²ç›¸é—œçš„MQTTè¨Šæ¯

## ğŸ§ª æ¸¬è©¦

### å¾Œç«¯è‡ªå‹•å•Ÿå‹•æ¸¬è©¦
```bash
./test_backend_auto_start.sh
```

### ç•«é¢è«‹æ±‚å”è­°æ¸¬è©¦  
```bash
./test_screen_request.sh
```

## ğŸ¯ ç”¨æˆ¶éœ€æ±‚é”æˆç‹€æ…‹

âœ… **å®Œå…¨é”æˆ**: "å‰ç«¯è¦è‡ªå·±é–‹å¾Œç«¯ä¾†æ¸¬ï¼Œç”¨è¨­å®šæª”è¨­å®šå¾Œç«¯åŸ·è¡Œè·¯å¾‘ï¼Œé€™æ¨£æˆ‘å€‘åªéœ€è¦å•Ÿå‹•å‰ç«¯å°±å¥½ï¼Œå¾Œç«¯çµ¦å‰ç«¯è‡ªå·±æ§åˆ¶æ‰å°"

- âœ… å‰ç«¯è‡ªå‹•å•Ÿå‹•å¾Œç«¯
- âœ… é…ç½®æª”æ¡ˆè¨­å®šå¾Œç«¯è·¯å¾‘
- âœ… åªéœ€å•Ÿå‹•å‰ç«¯å³å¯
- âœ… å‰ç«¯å®Œå…¨æ§åˆ¶å¾Œç«¯ç”Ÿå‘½é€±æœŸ

## ğŸ“Š é–‹ç™¼ç‹€æ…‹

| ä»»å‹™ | ç‹€æ…‹ | å®Œæˆåº¦ |
|------|------|--------|
| å‰ç«¯è‡ªå‹•é€£æ¥æœ¬åœ°ç«¯ | âœ… å®Œæˆ | 100% |
| ç•«é¢ç‹€æ…‹è«‹æ±‚æ©Ÿåˆ¶ | âœ… å®Œæˆ | 100% |
| ç•«é¢è«‹æ±‚å”è­°å¢å¼· | âœ… å®Œæˆ | 100% |
| MQTTè™•ç†å™¨æ”¯æ´ | âœ… å®Œæˆ | 100% |
| è«‹æ±‚æ¨¡å¼å¯¦ä½œ | âœ… å®Œæˆ | 100% |
| å‰ç«¯è‡ªå‹•å•Ÿå‹•å¾Œç«¯ | âœ… å®Œæˆ | 100% |
| é…ç½®æª”æ¡ˆç³»çµ± | âœ… å®Œæˆ | 100% |
| å¾Œç«¯ç¨‹åºç®¡ç† | âœ… å®Œæˆ | 100% |

**ç¸½é«”å®Œæˆåº¦: 100%** ğŸ‰

---

*æœ€å¾Œæ›´æ–°: 2025/08/06 18:05*  
*é–‹ç™¼è€…: Claude + ç”¨æˆ¶å”ä½œé–‹ç™¼*