# 螢幕顯示範圍功能

## 概述

這個功能讓 `omf` 前端在呼叫 `get_area` 事件時，能夠帶入玩家螢幕的顯示範圍，讓 `omb` 後端知道要傳送多少範圍內的遊戲單位給前端顯示。

## 功能特點

### 1. 螢幕範圍配置
- 支援不同螢幕解析度的自動調整
- 可配置最小/最大顯示範圍限制
- 支援動態範圍調整（根據縮放等）

### 2. 智能範圍計算
- 根據螢幕解析度自動計算顯示範圍
- 保持適當的寬高比
- 防止過度縮放或放大

### 3. MQTT 請求優化
- 使用 `get_area` 事件替代 `get_screen_area`
- 包含完整的範圍參數（min_x, min_y, max_x, max_y）
- 提供中心點和尺寸信息

## 配置說明

### config.toml 設定

```toml
[frontend.screen_range]
# 螢幕顯示範圍寬度（遊戲世界單位）
width = 400.0
# 螢幕顯示範圍高度（遊戲世界單位）
height = 300.0
# 是否啟用動態範圍調整（根據縮放等調整）
dynamic_range = true
# 最小顯示範圍（防止過度縮小）
min_width = 200.0
min_height = 150.0
# 最大顯示範圍（防止過度放大）
max_width = 800.0
max_height = 600.0
```

### 程式碼配置

```rust
// 根據螢幕解析度創建視窗
let viewport = Viewport::for_screen(1920, 1080);

// 獲取顯示範圍
let (min_x, min_y, max_x, max_y) = viewport.get_display_area();
```

## MQTT 請求格式

### get_area 請求

```json
{
    "name": "TestPlayer",
    "t": "screen_request",
    "a": "get_area",
    "d": {
        "player_name": "TestPlayer",
        "request_type": "screen_display_range",
        "min_x": -200.0,
        "min_y": -150.0,
        "max_x": 200.0,
        "max_y": 150.0,
        "width": 400.0,
        "height": 300.0,
        "center_x": 0.0,
        "center_y": 0.0,
        "timestamp": 1234567890123
    }
}
```

## 使用方式

### 1. 自動模式
前端會自動根據當前螢幕設定發送 `get_area` 請求，無需手動配置。

### 2. 手動調整
可以通過修改 `config.toml` 來調整顯示範圍設定。

### 3. 動態調整
支援在運行時動態調整顯示範圍（例如縮放功能）。

## 測試

運行測試腳本：

```bash
./test_screen_range.sh
```

測試會驗證：
- 配置載入是否正確
- 範圍計算是否準確
- MQTT 請求格式是否正確
- 後端回應是否正常

## 技術細節

### 範圍計算邏輯

1. **基礎範圍**：從配置檔案讀取基礎顯示範圍
2. **解析度調整**：根據螢幕解析度計算縮放因子
3. **寬高比保持**：確保顯示範圍保持適當的寬高比
4. **限制檢查**：確保範圍在最小/最大值範圍內

### 性能優化

- 範圍計算只在配置變更時執行
- MQTT 請求使用共享的遊戲狀態
- 支援異步處理，不阻塞主線程

## 與後端的整合

後端 `omb` 需要：

1. **接收 get_area 請求**：處理新的請求格式
2. **範圍過濾**：根據提供的範圍過濾遊戲單位
3. **回應格式**：返回指定範圍內的單位數據

## 未來擴展

- 支援多個視窗/分屏顯示
- 支援自定義範圍形狀（非矩形）
- 支援範圍預測（根據移動方向提前載入）
- 支援範圍快取和增量更新