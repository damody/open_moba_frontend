# Terminal View 系統

終端視圖系統負責在命令行界面中渲染遊戲世界，提供視覺化的遊戲狀態顯示。

## 🎮 系統概述

Terminal View 是一個完整的 ASCII 藝術渲染引擎，將遊戲世界轉換為可在終端中顯示的字符畫面。

## 📁 模組結構

### `mod.rs` - 模組入口
- 定義公共 API
- 匯出子模組
- 提供 `TerminalView` 主結構

### `viewport.rs` - 視口管理
- **功能**：管理可視區域和坐標轉換
- **核心概念**：
  - 世界坐標：遊戲世界的實際坐標 (0-800, 0-600)
  - 視口坐標：終端顯示的相對坐標
  - 自動跟隨：視口自動跟隨玩家移動
- **主要方法**：
  - `world_to_viewport()` - 世界坐標轉視口坐標
  - `viewport_to_world()` - 視口坐標轉世界坐標
  - `is_in_viewport()` - 檢查實體是否在視野內
  - `center_on()` - 將視口中心對準指定位置

### `renderer.rs` - 渲染器
- **功能**：將遊戲狀態轉換為終端字符
- **渲染元素**：
  - `@` - 玩家角色
  - `S` - 雜賀眾召喚物
  - `*` - 其他玩家
  - `#` - 障礙物（未來功能）
  - `.` - 空地
- **渲染流程**：
  1. 清空緩衝區
  2. 計算視口邊界
  3. 渲染地圖背景
  4. 渲染遊戲實體
  5. 渲染 UI 元素
  6. 輸出到終端

### `display.rs` - 顯示管理
- **功能**：處理終端輸出和格式化
- **特性**：
  - 雙緩衝技術減少閃爍
  - 智能刷新只更新變化部分
  - 支援顏色（如果終端支援）
  - 自適應終端大小
- **UI 元素**：
  - 頂部標題欄
  - 遊戲視圖區域
  - 底部狀態欄（血量、魔力、位置）
  - 訊息區域

### `input.rs` - 輸入處理
- **功能**：捕獲和處理鍵盤輸入
- **支援按鍵**：
  - `W/A/S/D` - 移動
  - `Q/E/R/F` - 技能快捷鍵
  - `Space` - 基礎攻擊
  - `V` - 切換視圖模式
  - `Tab` - 顯示記分板
  - `ESC` - 退出/返回
- **輸入模式**：
  - 即時模式：不需要按 Enter
  - 非阻塞：不會中斷遊戲循環

## 🎨 視覺設計

### 畫面佈局
```
╔════════════════════════════════════════════════════════╗
║                    Game Title                          ║
╠════════════════════════════════════════════════════════╣
║                                                        ║
║                    Game View Area                      ║
║                                                        ║
║                         @                              ║
║                      S  S  S                           ║
║                                                        ║
╠════════════════════════════════════════════════════════╣
║ HP: 100/100 | MP: 50/50 | Pos: (400, 300) | LV: 1    ║
╚════════════════════════════════════════════════════════╝
```

### 坐標系統
- **世界坐標**：
  - 原點 (0, 0) 在左上角
  - X 軸向右增加 (0-800)
  - Y 軸向下增加 (0-600)
  
- **視口坐標**：
  - 相對於視口左上角
  - 自動調整以保持玩家可見
  - 支援邊界檢查防止超出地圖

## 🔧 技術細節

### 性能優化
- 使用雙緩衝減少閃爍
- 只更新變化的部分
- 批量處理終端命令
- 異步渲染不阻塞遊戲邏輯

### 跨平台支援
- 使用 crossterm 庫確保跨平台相容
- 自動檢測終端能力
- 優雅降級（無顏色、無特殊字符）

### 配置選項
```rust
pub struct ViewConfig {
    pub viewport_width: u16,   // 視口寬度（字符）
    pub viewport_height: u16,  // 視口高度（字符）
    pub follow_player: bool,   // 是否跟隨玩家
    pub show_grid: bool,       // 是否顯示網格
    pub use_colors: bool,      // 是否使用顏色
}
```

## 🚀 使用範例

```rust
// 創建視圖系統
let mut view = TerminalView::new(ViewConfig::default());

// 更新遊戲狀態
view.update_state(&game_state);

// 渲染一幀
view.render()?;

// 處理輸入
if let Some(input) = view.get_input()? {
    match input {
        Input::Move(direction) => // 處理移動
        Input::Cast(ability) => // 處理技能
        // ...
    }
}
```

## 📝 開發注意事項

1. **坐標轉換**：始終使用 viewport 模組的轉換函數
2. **渲染順序**：背景 → 地形 → 實體 → UI
3. **錯誤處理**：終端操作可能失敗，需要妥善處理
4. **測試**：使用模擬終端進行單元測試

## 🎯 未來改進

- [ ] 支援小地圖
- [ ] 添加粒子效果
- [ ] 實現平滑滾動
- [ ] 支援更多實體類型
- [ ] 添加動畫系統
- [ ] 支援地形和障礙物