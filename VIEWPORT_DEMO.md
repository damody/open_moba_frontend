# omobaf 視窗範圍功能演示

## 🎮 虛擬螢幕範圍功能

omobaf 現在支援向後端傳送虛擬螢幕範圍資訊，後端可以根據這些資訊只發送該範圍內的遊戲事件，優化網路傳輸效率。

## 📊 發送的視窗資訊

每次視窗更新時，omobaf 會發送以下資訊到後端：

```json
{
  "t": "player_action",
  "a": "update_viewport",
  "d": {
    "center_x": 500.0,
    "center_y": 500.0,
    "width": 1920.0,
    "height": 1080.0,
    "zoom": 1.0,
    "min_x": -460.0,
    "min_y": -40.0,
    "max_x": 1460.0,
    "max_y": 1040.0
  }
}
```

## 🎯 視窗更新觸發時機

1. **進入遊戲時** - 發送初始視窗範圍
2. **移動時** - 視窗中心跟隨玩家位置
3. **手動調整** - 透過 `viewport` 和 `zoom` 指令

## 📋 互動式指令

### 查看當前視窗設置
```
[遊戲中] > viewport
當前視窗設置:
  中心: (0.0, 0.0)
  尺寸: 1920 x 1080
  縮放: 1.0x
  範圍: (-960.0, -540.0) 到 (960.0, 540.0)
```

### 設置視窗大小
```
[遊戲中] > viewport 1280 720
✓ 視窗大小設為: 1280 x 720
```

### 調整縮放等級
```
[遊戲中] > zoom 2.0
✓ 縮放設為: 2.0x
  新視窗範圍: (-320.0, -180.0) 到 (320.0, 180.0)
```

## 🚀 使用範例

### 完整的視窗操作流程
```bash
# 啟動互動式客戶端
./target/release/omobaf

# 遊戲中的操作
[未連接] > connect localhost
→ 連接到 localhost:1883...
✓ 連接成功！

[已連接] > play
→ 開始遊戲，英雄: saika_magoichi
✓ 已進入遊戲！
# 自動發送初始視窗範圍

[遊戲中] > viewport
當前視窗設置:
  中心: (0.0, 0.0)
  尺寸: 1920 x 1080
  縮放: 1.0x
  範圍: (-960.0, -540.0) 到 (960.0, 540.0)

[遊戲中] > move 500 500
→ 移動到 (500, 500)
✓ 移動完成
# 自動更新視窗中心並發送新範圍

[遊戲中] > viewport
當前視窗設置:
  中心: (500.0, 500.0)
  尺寸: 1920 x 1080
  縮放: 1.0x
  範圍: (-460.0, -40.0) 到 (1460.0, 1040.0)

[遊戲中] > zoom 0.5
✓ 縮放設為: 0.5x
  新視窗範圍: (-1420.0, -580.0) 到 (2420.0, 1580.0)
```

## 📡 MQTT 訊息格式

### 發送到的主題
```
td/{player_name}/action
```

### 訊息內容
```json
{
  "t": "player_action",
  "a": "update_viewport",
  "d": {
    "center_x": 視窗中心 X 座標,
    "center_y": 視窗中心 Y 座標,
    "width": 螢幕寬度,
    "height": 螢幕高度,
    "zoom": 縮放比例,
    "min_x": 可見區域最小 X,
    "min_y": 可見區域最小 Y,
    "max_x": 可見區域最大 X,
    "max_y": 可見區域最大 Y
  }
}
```

## 🎯 後端整合建議

有了這些視窗範圍資訊，後端可以：

1. **空間索引優化** - 只查詢視窗範圍內的遊戲對象
2. **事件過濾** - 只發送可見範圍內的事件
3. **LOD 系統** - 根據距離調整細節等級
4. **網路優化** - 減少不必要的資料傳輸

### 範圍檢查示例
```rust
// 檢查實體是否在玩家視窗範圍內
fn is_in_viewport(entity_pos: Vec2<f32>, viewport: &Viewport) -> bool {
    let (min, max) = viewport.get_bounds();
    entity_pos.x >= min.x && entity_pos.x <= max.x &&
    entity_pos.y >= min.y && entity_pos.y <= max.y
}
```

## ✅ 功能特點

- 🎮 **自動跟隨** - 視窗中心自動跟隨玩家移動
- 📏 **靈活配置** - 支援自訂視窗大小和縮放
- 📡 **即時同步** - 視窗變更立即發送給後端
- 🎯 **精確範圍** - 提供準確的可見區域座標
- 💻 **互動控制** - 透過 CLI 指令即時調整

現在 omobaf 具備了完整的虛擬螢幕範圍管理功能，可以有效協助後端進行空間優化和事件過濾！